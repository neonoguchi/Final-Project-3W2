import pygame
import random
import time

#window dimensions
window_width = 800
window_height = 800
window_dimensions = (window_width, window_height)

screen_width = 800
screen_height = 600
screen_dimensions = (screen_width,screen_height)

velo = 5

class Player():
    def __init__(self, x=600, y=550, width=25, height=25, health=100):
        self.width = width
        self.height = height
        self.rect = pygame.Rect(x, y, width, height)
        self.color = pygame.Color(0, 210, 0)
        self.health = health
        self.max_health = health
        self.dead = False

    def update(self):
        self._update_position()
        self._borders()
        #checks health for death
        if self.health < 1:
            self.dead = True
    
    def take_dmg(self, damage):
        self.health -= damage
        self.update()
    
    def _update_position(self):
        keys = pygame.key.get_pressed()
        if keys[pygame.K_w] and self.rect.y > 0:
            self.rect.y -= velo
        if keys[pygame.K_a] and self.rect.x > 0:
            self.rect.x -= velo
        if keys[pygame.K_s] and self.rect.y < screen_height - self.height:
            self.rect.y += velo
        if keys[pygame.K_d] and self.rect.x < screen_width - self.width:
            self.rect.x += velo

    def _borders(self):
        if self.rect.y <= 0:
            self.rect.y = 0
        elif self.rect.y >= screen_height:
            self.rect.y = screen_height
        
        if self.rect.x <= 0:
            self.rect.x = 0
        elif self.rect.x >= screen_width:
            self.rect.x = screen_width
    
    def draw(self, screen):
        if not self.dead:
            pygame.draw.rect(screen, self.color, self.rect)
    
    def draw_health_bar(self, screen):
        #displays hp of player
        health_bar_width = (self.health / self.max_health) * 100

        
        pygame.draw.rect(screen, (255,0,0), (self.rect.x - 39, self.rect.y - 15, 100, 5))
        pygame.draw.rect(screen, (0,255,0), (self.rect.x - 39, self.rect.y - 15, health_bar_width, 5))


class Door():
    def __init__(self, x=200, y=0, width=60, height=10):
        self.rect = pygame.Rect(x, y, width, height)
        self.color = 'Yellow'
        self.is_open = False
    
    def update(self, player):
        #player interact
        if self.rect.colliderect(player.rect):
            self.color = 'Yellow'
            #[E] interact with door
            if pygame.key.get_pressed()[pygame.K_e]:
                self.is_open = True
        else:
            self.color = 'Red'
    
    def _generate_new_door():
        #door locations simplified
        topside = Door(random.randrange(0, screen_width - 60, 60), 0, 60, 10)
        bottomside = Door(random.randrange(0, screen_width - 60, 60), (screen_height - 10), 60, 10)
        leftside = Door(0, random.randrange(0, screen_height, 60), 10, 60)
        rightside = Door((screen_width - 10), random.randrange(0, screen_height, 60), 10, 60)
        return random.choice([topside, bottomside, leftside, rightside])

    def draw(self,screen):
        pygame.draw.rect(screen, pygame.Color(self.color), self.rect)

class Score():
    def __init__(self, level, pos=(700,20)):
        self.level = level
        self.pos = pos
        self.font = pygame.font.Font(None,30)

    def draw(self,screen):
        text = self.font.render(f"Lvl: {self.level}", True, 'White')
        screen.blit(text, self.pos)

class Hostile():
    def __init__(self, width=40, height=40):
        self.width = width
        self.height = height
        self.rect = pygame.Rect(random.randrange(screen_width - width), random.randrange(screen_height - height), width, height)
        self.color = pygame.Color('Red')
        self.base_velocity = 2
        self.velocity = self.base_velocity
        self.direction_x = random.choice([-1, 1])
        self.direction_y = random.choice([-1, 1])

    def update(self, player, score):
        self._check_level(player, score)
        self._update_position()
        #damage to player
        if self.rect.colliderect(player.rect):
            self.color = 'Blue'
            player.take_dmg(5)
            print(player.health)
        else:
            self.color = 'Red'
    
    def _check_level(self, player, score):
        # if score.level > 20:
        #     self.velocity = self.base_velocity * 5
        # elif score.level > 15:
        #     self.velocity = self.base_velocity * 4
        if score.level > 10:
            self.velocity = self.base_velocity * 3
        elif score.level > 5:
            self.velocity = self.base_velocity * 2

    def _update_position(self):
        #movement of hostile
        self.rect.x += self.velocity * self.direction_x
        self.rect.y += self.velocity * self.direction_y
        #east/west walls
        if self.rect.left < 0 or self.rect.right > screen_width:
            self.direction_x *= -1
        #north/south walls
        if self.rect.top < 0 or self.rect.bottom > screen_height:
            self.direction_y *= -1

    def draw(self, screen):
        pygame.draw.rect(screen, self.color, self.rect)

def generate_level(player, door, hostile):
    #player spawn based off of previous door
    if door.rect.x == 0:
        player.rect.topleft = (screen_width - player.rect.width, door.rect.centery - player.rect.height // 2)
    elif door.rect.x == screen_width - door.rect.width:
        player.rect.topleft = (0, door.rect.centery - player.rect.height // 2)
    elif door.rect.y == 0:
        player.rect.topleft = (door.rect.centerx - player.rect.width // 2, screen_height - player.rect.height)
    elif door.rect.y == screen_height - door.rect.height:
        player.rect.topleft = (door.rect.centerx - player.rect.width // 2, 0)
    door.color = 'Yellow'
    door.is_open = False

    #hostile spawn
    hostile.rect.x = random.randrange(screen_width - hostile.width)
    hostile.rect.y = random.randrange(screen_height - hostile.height)

def main():
    pygame.init()
    pygame.display.set_caption("Simple RPG")
    screen = pygame.display.set_mode(window_dimensions)
    clock = pygame.time.Clock()
    
    level = 1
    score= Score(level)
    
    player = Player()
    door = Door()
    hostile = Hostile()
    generate_level(player, door, hostile)

    #game loop
    running = True
    while running:
        #event handler
        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                running = False
        #GAME JOVER
        if player.dead:
            #display game over screen that has:
            #"GAME OVER" text
            #retry button
            #quit button
            running = False


        #updates
        player.update()
        hostile.update(player, score)
        door.update(player)

        #background fill
        display_bg_color = ((15,30,15))
        console_color = ((255, 244, 210))
        screen.fill(console_color)
        pygame.draw.rect(screen, display_bg_color, (0, 0, screen_width, screen_height))

        #draw
        player.draw(screen)
        player.draw_health_bar(screen)
        door.draw(screen)
        score.draw(screen)
        hostile.draw(screen)

        if door.is_open:
            generate_level(player, door, hostile)
            level += 1
            print(f"Door opened! Transitioning to level {level}")
            score.level = level
            door = Door._generate_new_door()
        
        pygame.display.update()
        clock.tick(60) #fps


if __name__ == "__main__":
    main()